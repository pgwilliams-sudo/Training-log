<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#3b82f6">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;background:#f5f5f5;padding:10px;margin:0;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.week-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:4px;margin-top:8px;}
.week-btn{padding:6px;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;}
.week-btn.active{background:#3b82f6;color:#fff;}
.week-btn.inactive{background:#e5e7eb;}
select,input,textarea,button{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:0.85rem;}
input[type=number]{width:70px;}
textarea{resize:none;width:100%;}
button{cursor:pointer;}
.session{border-top:1px solid #eee;padding-top:8px;margin-top:8px;}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:8px;border-radius:6px;flex:1;min-width:120px;}
.curr{flex:1;min-width:160px;}
.set{display:flex;gap:4px;margin-bottom:4px;align-items:center;flex-wrap:wrap;}
.iso{background:#fafafa;padding:6px;border-radius:6px;margin-bottom:6px;}
.locked{opacity:.6;}
.hidden{display:none;}
.small{font-size:11px;color:#555;}
</style>
</head>

<body>

<div class="card">
  <h2>GymTrack Stats</h2>
  <div class="row" style="align-items:center;">
    <button onclick="changeWeek(-1)">â—€</button>
    <strong id="weekTitle">Week 1</strong>
    <button onclick="changeWeek(1)">â–¶</button>

    <button onclick="exportData()">Export</button>
    <button onclick="document.getElementById('importFile').click()">Import</button>
    <input type="file" id="importFile" accept=".json" hidden>

    <button onclick="toggleStats()">Cycle Stats</button>
    <button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
  </div>

  <div id="weekGrid" class="week-grid"></div>
</div>

<div id="loggerView">
  <div class="card">
    <button onclick="addSession()">âž• Add Session</button>
  </div>

  <div id="sessions"></div>

  <div class="card">
    <canvas id="rmChart"></canvas>
  </div>
</div>

<div id="statsView" class="hidden">
  <div class="card">
    <h3>Cycle Stats</h3>
    <div id="statsContent"></div>
  </div>
</div>

<script>
const MAX_WEEKS = 12;
const LIFTS = ['Squat','Bench','Deadlift','Row','Overhead Press'];
const CORE_LIFTS = ['Squat','Bench','Deadlift'];
let currentWeek = 1;

/* ---------------- DB ---------------- */
let db = JSON.parse(localStorage.getItem('db')) || {
  cycle: 1,
  weeks: {},
  pbs: {Squat:0,Bench:0,Deadlift:0}
};

for(let i=1;i<=MAX_WEEKS;i++){
  if(!db.weeks[i]) db.weeks[i] = { sessions: [] };
}

function saveDB(){ localStorage.setItem('db', JSON.stringify(db)); }

/* ---------------- HELPERS ---------------- */
function prevSession(lift){
  let found = null;
  Object.values(db.weeks).forEach(w=>{
    w.sessions.forEach(s=>{
      if(s.lift===lift && s.completed) found = s;
    });
  });
  return found;
}

/* ---------------- SESSIONS ---------------- */
function addSession(){
  db.weeks[currentWeek].sessions.push({
    id: crypto.randomUUID(),
    lift: 'Squat',
    sets: Array.from({length:5},()=>({w:'',r:''})),
    isolations: Array.from({length:3},()=>({})),
    notes:'',
    completed:false
  });
  saveDB();
  render();
}

function deleteSession(id){
  if(!confirm('Delete this session?')) return;
  db.weeks[currentWeek].sessions =
    db.weeks[currentWeek].sessions.filter(s=>s.id!==id);
  saveDB();
  render();
}

function completeSession(id){
  const s = db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.completed = true;

  if(CORE_LIFTS.includes(s.lift)){
    const maxW = Math.max(...s.sets.map(x=>Number(x.w)||0));
    if(maxW > db.pbs[s.lift]) db.pbs[s.lift] = maxW;
  }

  saveDB();
  render();

  if(isCycleComplete()){
    setTimeout(()=>{
      if(confirm(`Cycle ${db.cycle} complete. Export backup?`)){
        exportData();
      }
      db.cycle++;
      currentWeek = 1;
      saveDB();
      render();
    },300);
  }
}

function editSession(id){
  const s = db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.completed = false;
  saveDB();
  render();
}

/* ---------------- RENDER ---------------- */
function render(){
  document.getElementById('weekTitle').textContent = `Week ${currentWeek}`;
  renderWeekButtons();

  const c = document.getElementById('sessions');
  c.innerHTML = '';

  db.weeks[currentWeek].sessions.forEach(s=>{
    const prev = prevSession(s.lift);

    const card = document.createElement('div');
    card.className = 'card session'+(s.completed?' locked':'');

    card.innerHTML = `
      <div class="row">
        <select onchange="sChangeLift('${s.id}',this.value)">
          ${LIFTS.map(l=>`<option ${l===s.lift?'selected':''}>${l}</option>`).join('')}
        </select>
        <button onclick="deleteSession('${s.id}')">ðŸ—‘</button>
      </div>
      <div class="row">
        <div class="prev">
          <strong>Previous</strong><br>
          ${prev?prev.sets.map(x=>`${x.w}Ã—${x.r}`).join('<br>'):'â€”'}
        </div>
        <div class="curr" id="curr-${s.id}"></div>
      </div>
    `;

    const curr = card.querySelector(`#curr-${s.id}`);

    s.sets.forEach((set,i)=>{
      curr.innerHTML+=`
        <div class="set">
          ${i+1}
          <input type="number" value="${set.w}" onblur="uSet('${s.id}',${i},'w',this.value)">
          <input type="number" value="${set.r}" onblur="uSet('${s.id}',${i},'r',this.value)">
        </div>`;
    });

    curr.innerHTML += `<strong>Isolation</strong>`;
    s.isolations.forEach((iso,i)=>{
      curr.innerHTML+=`
        <div class="iso">
          <input placeholder="Exercise" value="${iso.name||''}" onblur="uIso('${s.id}',${i},'name',this.value)">
          <input type="number" placeholder="Sets" value="${iso.sets||''}" onblur="uIso('${s.id}',${i},'sets',this.value)">
          <input type="number" placeholder="Reps" value="${iso.reps||''}" onblur="uIso('${s.id}',${i},'reps',this.value)">
          <input type="number" placeholder="Weight" value="${iso.weight||''}" onblur="uIso('${s.id}',${i},'weight',this.value)">
        </div>`;
    });

    curr.innerHTML+=`
      <textarea onblur="uNotes('${s.id}',this.value)">${s.notes}</textarea>
      ${s.completed
        ? `<button onclick="editSession('${s.id}')">Edit</button>`
        : `<button onclick="completeSession('${s.id}')">Complete</button>`
      }
    `;

    if(s.completed){
      card.querySelectorAll('input,textarea,select').forEach(i=>i.disabled=true);
    }

    c.appendChild(card);
  });

  drawChart();
}

/* ---------------- UPDATERS ---------------- */
function sChangeLift(id,v){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.lift=v;
  saveDB(); render();
}
function uSet(id,i,f,v){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.sets[i][f]=v; saveDB();
}
function uIso(id,i,f,v){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.isolations[i][f]=v; saveDB();
}
function uNotes(id,v){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.notes=v; saveDB();
}

/* ---------------- NAV ---------------- */
function changeWeek(d){
  currentWeek=Math.max(1,Math.min(MAX_WEEKS,currentWeek+d));
  render();
}
function renderWeekButtons(){
  const g=document.getElementById('weekGrid'); g.innerHTML='';
  for(let i=1;i<=MAX_WEEKS;i++){
    const b=document.createElement('button');
    b.textContent=`W${i}`;
    b.className='week-btn '+(i===currentWeek?'active':'inactive');
    b.onclick=()=>{currentWeek=i;render();};
    g.appendChild(b);
  }
}

/* ---------------- CYCLE ---------------- */
function isCycleComplete(){
  if(currentWeek!==12) return false;
  return CORE_LIFTS.every(l=>{
    return db.weeks[12].sessions.some(s=>s.lift===l && s.completed);
  });
}

/* ---------------- IMPORT / EXPORT ---------------- */
function exportData(){
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='gymtrack-backup.json';
  a.click();
}
document.getElementById('importFile').addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    if(confirm('Replace all data?')){
      db=JSON.parse(ev.target.result);
      saveDB(); render();
    }
  };
  r.readAsText(f);
});

/* ---------------- STATS ---------------- */
function toggleStats(){
  document.getElementById('loggerView').classList.toggle('hidden');
  document.getElementById('statsView').classList.toggle('hidden');
}

/* ---------------- CHART ---------------- */
let chart;
function drawChart(){
  const ctx=document.getElementById('rmChart');
  if(chart) chart.destroy();

  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:Array.from({length:MAX_WEEKS},(_,i)=>`W${i+1}`),
      datasets:CORE_LIFTS.map(l=>{
        return{
          label:l,
          data:Array.from({length:MAX_WEEKS},(_,i)=>{
            const w=db.weeks[i+1];
            if(!w) return null;
            const s=w.sessions.filter(x=>x.lift===l && x.completed);
            if(!s.length) return null;
            return Math.max(...s.map(x=>Math.max(...x.sets.map(y=>Number(y.w)||0))));
          })
        };
      })
    }
  });
}

/* ---------------- INIT ---------------- */
render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training Logger PWA</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
    background:#f4f6f8;
    margin:0;
    padding:16px;
}

h1,h2,h3 {
    margin:8px 0;
}

.card {
    background:#fff;
    border-radius:8px;
    padding:16px;
    margin-bottom:16px;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
}

select,input,textarea,button {
    padding:6px;
    font-size:14px;
}

.set-row {
    display:flex;
    gap:6px;
    margin-bottom:6px;
    align-items:center;
}

.prev-box {
    background:#eef2f7;
    padding:10px;
    border-radius:6px;
    font-size:13px;
    margin-bottom:10px;
}

.weight-up { background:#dcfce7; }
.weight-down { background:#fee2e2; }
.pb { background:gold; padding:2px 6px; border-radius:4px; font-size:12px; }

.locked input, .locked select, .locked textarea {
    background:#eee;
    pointer-events:none;
}

.iso-box {
    background:#fafafa;
    padding:8px;
    border-radius:6px;
    margin-bottom:6px;
}

.chart-box {
    background:#fff;
    padding:16px;
    border-radius:8px;
}
</style>
</head>

<body>

<h1>Training Logger</h1>

<div class="card">
    Week:
    <select id="weekSelect"></select>

    Session Type:
    <select id="sessionType"></select>

    <button onclick="resetAll()">Reset All</button>
</div>

<div id="sessionContainer"></div>

<div class="chart-box">
    <h3>1RM Progression</h3>
    <canvas id="rmChart"></canvas>
    <div id="bestRM"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ------------------ DATA LAYER ------------------ */

const STORAGE_KEY = "trainingDB_v3";

let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    sessions: []
};

function saveDB() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}

function newSession(week, lift, type) {
    return {
        id: crypto.randomUUID(),
        week,
        lift,
        type,
        completed:false,
        notes:"",
        sets:[],
        isolations:[{name:"",sets:"",reps:"",weight:""}]
    };
}

/* ------------------ CONSTANTS ------------------ */

const LIFTS = ["Squat","Bench","Deadlift"];
const SESSION_TYPES = [
    "GVT",
    "Core",
    "Breakdown Banded",
    "Breakdown Pause",
    "Breakdown Other",
    "Mini-Peak",
    "Peak"
];

/* ------------------ UI INIT ------------------ */

const weekSelect = document.getElementById("weekSelect");
const typeSelect = document.getElementById("sessionType");
const container = document.getElementById("sessionContainer");

for(let i=1;i<=12;i++){
    weekSelect.innerHTML += `<option value="${i}">Week ${i}</option>`;
}
SESSION_TYPES.forEach(t=>{
    typeSelect.innerHTML += `<option>${t}</option>`;
});

weekSelect.onchange = render;
typeSelect.onchange = render;

/* ------------------ HELPERS ------------------ */

function getSetsCount(type){
    return type==="GVT" ? 10 : 5;
}

function lastEquivalent(lift,type,currentWeek){
    return db.sessions
        .filter(s=>s.lift===lift && s.type===type && s.week < currentWeek && s.completed)
        .sort((a,b)=>b.week-a.week)[0];
}

function calc1RM(set){
    return Math.round(set.weight*(1+set.reps/30));
}

/* ------------------ RENDER ------------------ */

function render(){
    container.innerHTML = "";
    const week = +weekSelect.value;
    const type = typeSelect.value;

    LIFTS.forEach(lift=>{
        let session = db.sessions.find(s=>s.week===week && s.lift===lift);
        if(!session){
            session = newSession(week,lift,type);
            db.sessions.push(session);
            saveDB();
        }

        const prev = lastEquivalent(lift,type,week);

        const card = document.createElement("div");
        card.className = "card" + (session.completed?" locked":"");

        let html = `<h3>${lift}</h3>`;

        if(prev){
            html += `<div class="prev-box">
                <strong>Previous ${type}</strong><br>
                ${prev.sets.map(s=>`${s.weight}Ã—${s.reps}`).join(", ")}
            </div>`;
        }

        const setCount = getSetsCount(type);

        for(let i=0;i<setCount;i++){
            const s = session.sets[i] || {weight:"",reps:""};
            html += `
            <div class="set-row">
                <input type="number" placeholder="Weight"
                    value="${s.weight}"
                    onblur="updateSet('${session.id}',${i},'weight',this.value)">
                <input type="number" placeholder="Reps"
                    value="${s.reps}"
                    onblur="updateSet('${session.id}',${i},'reps',this.value)">
            </div>`;
        }

        html += `<h4>Isolations</h4>`;
        session.isolations.forEach((iso,idx)=>{
            html+=`
            <div class="iso-box">
                <input placeholder="Name" value="${iso.name}"
                  onblur="updateIso('${session.id}',${idx},'name',this.value)">
                <input placeholder="Sets" value="${iso.sets}"
                  onblur="updateIso('${session.id}',${idx},'sets',this.value)">
                <input placeholder="Reps" value="${iso.reps}"
                  onblur="updateIso('${session.id}',${idx},'reps',this.value)">
                <input placeholder="Weight" value="${iso.weight}"
                  onblur="updateIso('${session.id}',${idx},'weight',this.value)">
            </div>`;
        });

        html += `
        <textarea maxlength="260" placeholder="Notes"
          onblur="updateNotes('${session.id}',this.value)">${session.notes}</textarea>
        <br>
        <button onclick="completeSession('${session.id}')">Complete Session</button>`;

        card.innerHTML = html;
        container.appendChild(card);
    });

    renderChart();
}

/* ------------------ UPDATE HANDLERS ------------------ */

function updateSet(id,i,field,val){
    const s = db.sessions.find(x=>x.id===id);
    s.sets[i] ||= {};
    s.sets[i][field] = +val;
    saveDB();
}

function updateIso(id,i,field,val){
    const s = db.sessions.find(x=>x.id===id);
    s.isolations[i][field] = val;
    saveDB();
}

function updateNotes(id,val){
    db.sessions.find(x=>x.id===id).notes = val;
    saveDB();
}

function completeSession(id){
    const s = db.sessions.find(x=>x.id===id);
    s.completed = true;
    saveDB();
    render();
}

function resetAll(){
    if(confirm("Delete ALL data?")){
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

/* ------------------ CHART ------------------ */

let chart;
function renderChart(){
    const ctx = document.getElementById("rmChart");
    const rms = db.sessions
        .filter(s=>s.completed)
        .map(s=>{
            const best = Math.max(...s.sets.map(set=>calc1RM(set)||0));
            return {week:s.week,rm:best};
        });

    const labels = rms.map(r=>`W${r.week}`);
    const data = rms.map(r=>r.rm);

    if(chart) chart.destroy();
    chart = new Chart(ctx,{
        type:"line",
        data:{labels,datasets:[{label:"1RM",data}]}
    });

    document.getElementById("bestRM").textContent =
        "Best 1RM: " + Math.max(0,...data);
}

render();
</script>
</body>
</html>

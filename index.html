<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Training Logger</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial;background:#f5f5f5;padding:15px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.row{display:flex;gap:10px;flex-wrap:wrap}
select,input,textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc}
button{cursor:pointer}
.session{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:10px;border-radius:6px;flex:1}
.curr{flex:1}
.set{display:flex;gap:6px;margin-bottom:6px;align-items:center}
.iso{background:#fafafa;padding:8px;border-radius:6px;margin-bottom:6px}
.green{background:#dcfce7}
.red{background:#fee2e2}
.gold{background:#fde68a}
.small{font-size:12px;color:#555}
textarea{resize:none}
</style>
</head>

<body>
<div class="card">
  <h2>Training Logger</h2>
  <div class="row">
    <select id="cycle">
      <option>Strength</option>
      <option>Hybrid</option>
    </select>

    <select id="weekType">
      <option>GVT</option>
      <option>Core Session</option>
      <option>Breakdown Banded</option>
      <option>Breakdown Pause</option>
      <option>Breakdown Other</option>
      <option>Mini-Peak</option>
      <option>Peak</option>
    </select>

    <button onclick="changeWeek(-1)">◀</button>
    <input id="weekNum" type="number" min="1" max="999" style="width:70px"/>
    <button onclick="changeWeek(1)">▶</button>

    <button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
  </div>
</div>

<div id="sessions"></div>

<div class="card">
  <canvas id="rmChart"></canvas>
</div>

<script>
'use strict';

/* -------------------- DATA -------------------- */
let data = JSON.parse(localStorage.getItem('log')) || {weeks:{},history:[],pbs:{}};
let currentWeek = 1;

function save(){localStorage.setItem('log',JSON.stringify(data));}

/* -------------------- HELPERS -------------------- */
function calc1RM(w,r){return r>0?Math.round(w*(1+r/30)):0;}

function avg1RM(sets,peak){
  if(!sets.length) return 0;
  if(peak) return Math.max(...sets.map(s=>calc1RM(s.w,s.r)));
  return Math.round(sets.reduce((a,s)=>a+calc1RM(s.w,s.r),0)/sets.length);
}

function prevSession(lift,weekType){
  return [...data.history].reverse().find(h=>h.lift===lift&&h.weekType===weekType)||null;
}

/* -------------------- RENDER -------------------- */
function render(){
  const cycle=document.getElementById('cycle').value;
  const weekType=document.getElementById('weekType').value;
  document.getElementById('weekNum').value=currentWeek;

  if(!data.weeks[currentWeek])
    data.weeks[currentWeek]={cycle,weekType,sessions:{}};

  const wk=data.weeks[currentWeek];
  wk.cycle=cycle; wk.weekType=weekType;

  const container=document.getElementById('sessions');
  container.innerHTML='';

  ['Squat','Bench','Deadlift'].forEach(lift=>{
    if(!wk.sessions[lift])
      wk.sessions[lift]={sets:[],isolations:[{},{},{}],notes:''};

    const ses=wk.sessions[lift];
    const prev=prevSession(lift,weekType);

    const gvt = weekType==='GVT';
    const setCount = gvt ? 10 : 5;
    const fixedReps = gvt ? (cycle==='Strength'?5:10) : null;

    while(ses.sets.length<setCount) ses.sets.push({w:'',r:fixedReps||''});
    ses.sets=ses.sets.slice(0,setCount);

    const card=document.createElement('div');
    card.className='card session';
    card.innerHTML=`<h3>${lift}</h3>`;

    const row=document.createElement('div'); row.className='row';

    /* PREVIOUS */
    const prevBox=document.createElement('div'); prevBox.className='prev';
    prevBox.innerHTML=`<strong>Previous</strong><br/>`+
      (prev?`1RM: ${prev.avg1RM}<br/>`:'—');
    if(prev){
      prev.sets.forEach(s=>prevBox.innerHTML+=`${s.w} x ${s.r}<br/>`);
      prev.isolations.forEach(i=>{
        if(i.name) prevBox.innerHTML+=`<span class="small">${i.name} ${i.sets}x${i.reps}@${i.weight}</span><br/>`;
      });
    }

    /* CURRENT */
    const curr=document.createElement('div'); curr.className='curr';

    ses.sets.forEach((s,i)=>{
      const div=document.createElement('div'); div.className='set';
      div.innerHTML=
        `<span>${i+1}</span>
        <input type=number value="${s.w}" placeholder="kg"
          oninput="sesSet('${lift}',${i},'w',this.value)">
        <input type=number value="${s.r}" placeholder="reps" ${fixedReps?'disabled':''}
          oninput="sesSet('${lift}',${i},'r',this.value)">`;
      curr.appendChild(div);
    });

    /* ISOLATIONS */
    curr.innerHTML+=`<strong>Isolation</strong>`;
    ses.isolations.forEach((iso,i)=>{
      if(!iso.name&&prev?.isolations?.[i]) iso.name=prev.isolations[i].name;
      if(!iso.sets&&prev?.isolations?.[i]) iso.sets=prev.isolations[i].sets;
      if(!iso.reps&&prev?.isolations?.[i]) iso.reps=prev.isolations[i].reps;
      if(!iso.weight&&prev?.isolations?.[i]) iso.weight=prev.isolations[i].weight;

      curr.innerHTML+=
      `<div class="iso">
        <input placeholder="Exercise" value="${iso.name||''}"
          oninput="isoSet('${lift}',${i},'name',this.value)">
        <input type=number placeholder="Sets" value="${iso.sets||''}"
          oninput="isoSet('${lift}',${i},'sets',this.value)">
        <input type=number placeholder="Reps" value="${iso.reps||''}"
          oninput="isoSet('${lift}',${i},'reps',this.value)">
        <input type=number placeholder="Weight" value="${iso.weight||''}"
          oninput="isoSet('${lift}',${i},'weight',this.value)">
      </div>`;
    });

    curr.innerHTML+=
      `<textarea maxlength=260 placeholder="Notes"
        oninput="noteSet('${lift}',this.value)">${ses.notes}</textarea>
       <button onclick="complete('${lift}')">Complete Session</button>`;

    row.append(prevBox,curr); card.appendChild(row); container.appendChild(card);
  });

  drawChart();
  save();
}

/* -------------------- UPDATERS -------------------- */
function sesSet(l,i,f,v){data.weeks[currentWeek].sessions[l].sets[i][f]=v;save();}
function isoSet(l,i,f,v){data.weeks[currentWeek].sessions[l].isolations[i][f]=v;save();}
function noteSet(l,v){data.weeks[currentWeek].sessions[l].notes=v;save();}

/* -------------------- COMPLETE -------------------- */
function complete(lift){
  const wk=data.weeks[currentWeek];
  const ses=wk.sessions[lift];

  ses.isolations.forEach(i=>{for(let k in i) if(i[k]===undefined) i[k]='';});

  const avg=avg1RM(ses.sets,wk.weekType==='Peak');
  data.history.push({
    lift,weekType:wk.weekType,sets:JSON.parse(JSON.stringify(ses.sets)),
    isolations:JSON.parse(JSON.stringify(ses.isolations)),
    avg1RM:avg
  });

  if(!data.pbs[lift]||avg>data.pbs[lift]) data.pbs[lift]=avg;
  save(); render();
}

/* -------------------- NAV -------------------- */
function changeWeek(d){currentWeek=Math.max(1,currentWeek+d);render();}
function resetAll(){if(confirm('Delete all data?')){data={weeks:{},history:[],pbs:{}};currentWeek=1;save();render();}}

/* -------------------- CHART -------------------- */
let chart;
function drawChart(){
  const ctx=document.getElementById('rmChart');
  if(chart) chart.destroy();
  const lifts=['Squat','Bench','Deadlift'];
  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:data.history.map((_,i)=>i+1),
      datasets:lifts.map(l=>({
        label:l,
        data:data.history.filter(h=>h.lift===l).map(h=>h.avg1RM),
        fill:false
      }))
    }
  });
}

render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Training Logger</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  background:#f5f5f5;
  padding:16px;
}
.card {
  background:#fff;
  padding:16px;
  margin-bottom:16px;
  border-radius:8px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}
.row { display:flex; gap:8px; flex-wrap:wrap; }
input, select, textarea {
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px;
}
button {
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:#2563eb;
  color:#fff;
}
button.locked { background:#9ca3af; }
.set { display:flex; gap:6px; margin-bottom:6px; }
.prev {
  background:#f0f9ff;
  padding:8px;
  border-radius:6px;
  font-size:13px;
}
.pb { background:gold; padding:4px 8px; border-radius:6px; font-weight:600; }
.up { background:#dcfce7; }
.down { background:#fee2e2; }
.iso-prev {
  font-size:12px;
  color:#555;
  background:#f8fafc;
  padding:6px;
  border-radius:6px;
}
.chart-box {
  background:#fff;
  padding:12px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="card">
  <h2>Training Logger</h2>
  <div class="row">
    <button onclick="changeWeek(-1)">◀</button>
    <strong id="weekLabel"></strong>
    <button onclick="changeWeek(1)">▶</button>
    <button onclick="resetData()" style="background:#dc2626">Reset</button>
  </div>
</div>

<div id="sessions"></div>

<div class="chart-box">
  <h3>1RM Progress</h3>
  <canvas id="rmChart" height="160"></canvas>
  <div id="actualMax"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------------- STORAGE ---------------- */

let db = JSON.parse(localStorage.getItem("trainingDB")) || {
  sessions: [],
  currentWeek: 1
};

function saveDB() {
  localStorage.setItem("trainingDB", JSON.stringify(db));
}

/* ---------------- CONSTANTS ---------------- */

const lifts = ["Squat","Bench","Deadlift"];
const sessionTypes = ["GVT","Core","Breakdown Banded","Breakdown Pause","Breakdown Other","Mini-Peak","Peak"];

/* ---------------- HELPERS ---------------- */

function setsFor(type) {
  return type === "GVT" ? 10 : 5;
}

function findSession(week,lift) {
  return db.sessions.find(s => s.week===week && s.lift===lift);
}

function prevSession(lift,type,week) {
  return [...db.sessions]
    .reverse()
    .find(s => s.lift===lift && s.sessionType===type && s.week<week);
}

function prevIso(lift,week) {
  return [...db.sessions]
    .reverse()
    .find(s => s.lift===lift && s.week<week);
}

function best1RM(session) {
  let max = 0;
  session.sets.forEach(s=>{
    if(s.weight && s.reps) {
      const rm = session.sessionType==="Peak"
        ? s.weight
        : s.weight * (1 + s.reps/30);
      if(rm>max) max=rm;
    }
  });
  return Math.round(max);
}

/* ---------------- RENDER ---------------- */

function render() {
  document.getElementById("weekLabel").textContent = "Week " + db.currentWeek;
  const root = document.getElementById("sessions");
  root.innerHTML = "";

  lifts.forEach(lift=>{
    let session = findSession(db.currentWeek,lift);
    if(!session) {
      session = {
        week: db.currentWeek,
        lift,
        cycle:"Strength",
        sessionType:"GVT",
        sets: Array.from({length:10},()=>({weight:"",reps:""})),
        isolations: Array.from({length:3},()=>({name:"",sets:"",reps:"",weight:""})),
        completed:false
      };
      db.sessions.push(session);
      saveDB();
    }

    const prev = prevSession(lift,session.sessionType,db.currentWeek);
    const prevIsoData = prevIso(lift,db.currentWeek);

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML = `
      <h3>${lift}</h3>
      <div class="row">
        <select ${session.completed?"disabled":""}
          onchange="updateType('${lift}',this.value)">
          ${sessionTypes.map(t=>`<option ${t===session.sessionType?"selected":""}>${t}</option>`).join("")}
        </select>
      </div>

      ${prev?`<div class="prev">
        Prev ${session.sessionType}: ${best1RM(prev)}kg
      </div>`:""}

      ${session.sets.map((s,i)=>`
        <div class="set">
          <input type="number" placeholder="kg"
            value="${s.weight}"
            ${session.completed?"disabled":""}
            onblur="autoCopyWeight('${lift}',${i},this.value)">
          <input type="number" placeholder="reps"
            value="${s.reps}"
            ${session.completed?"disabled":""}
            onblur="autoCopyReps('${lift}',${i},this.value)">
        </div>`).join("")}

      <h4>Isolations</h4>
      ${prevIsoData?`<div class="iso-prev">
        Last: ${prevIsoData.isolations.map(i=>i.name+" "+i.weight+"kg").join(" | ")}
      </div>`:""}

      ${session.isolations.map((i,idx)=>`
        <div class="set">
          <input placeholder="Name" value="${i.name}"
            ${session.completed?"disabled":""}
            onchange="updateIso('${lift}',${idx},'name',this.value)">
          <input placeholder="kg" value="${i.weight}"
            ${session.completed?"disabled":""}
            onchange="updateIso('${lift}',${idx},'weight',this.value)">
        </div>`).join("")}

      <button onclick="completeSession('${lift}')"
        class="${session.completed?"locked":""}">
        ${session.completed?"Completed":"Complete Session"}
      </button>
    `;

    root.appendChild(card);
  });

  renderChart();
}

/* ---------------- ACTIONS ---------------- */

function updateType(lift,type) {
  const s = findSession(db.currentWeek,lift);
  if(s.completed) return;
  s.sessionType = type;
  s.sets = Array.from({length:setsFor(type)},()=>({weight:"",reps:""}));
  saveDB();
  render();
}

function autoCopyWeight(lift,i,val) {
  const s = findSession(db.currentWeek,lift);
  if(s.sessionType==="GVT" && i===0) {
    s.sets.forEach((set,idx)=>{ if(idx>0) set.weight=val; });
    saveDB(); render();
  }
}

function autoCopyReps(lift,i,val) {
  const s = findSession(db.currentWeek,lift);
  if(s.sessionType!=="GVT" && i===0) {
    s.sets.forEach((set,idx)=>{ if(idx>0) set.reps=val; });
    saveDB(); render();
  }
}

function updateIso(lift,i,field,val) {
  findSession(db.currentWeek,lift).isolations[i][field]=val;
  saveDB();
}

function completeSession(lift) {
  findSession(db.currentWeek,lift).completed=true;
  saveDB(); render();
}

function changeWeek(d) {
  db.currentWeek=Math.min(12,Math.max(1,db.currentWeek+d));
  saveDB(); render();
}

function resetData() {
  if(confirm("Delete all data?")) {
    localStorage.removeItem("trainingDB");
    location.reload();
  }
}

/* ---------------- CHART ---------------- */

function renderChart() {
  const ctx=document.getElementById("rmChart");
  const data=lifts.map(l=>{
    return db.sessions
      .filter(s=>s.lift===l)
      .map(s=>best1RM(s));
  });
  if(window.rmChart) window.rmChart.destroy();
  window.rmChart=new Chart(ctx,{
    type:"line",
    data:{ labels:data[0].map((_,i)=>i+1),
      datasets:data.map((d,i)=>({label:lifts[i],data:d}))
    }
  });
}

render();
</script>
</body>
</html>

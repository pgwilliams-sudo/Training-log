<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#3b82f6">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;background:#f5f5f5;padding:10px;margin:0;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.week-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:4px;margin-top:8px;}
.week-btn{padding:6px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;}
.week-btn.active{background:#3b82f6;color:#fff;}
.week-btn.inactive{background:#e5e7eb;}
select,input,textarea,button{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:.85rem;}
input[type=number]{width:70px;}
textarea{resize:none;width:100%;}
.session{border-top:1px solid #eee;padding-top:8px;margin-top:8px;}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:8px;border-radius:6px;flex:1;}
.curr{flex:1;}
.set{display:flex;gap:4px;margin-bottom:4px;}
.iso{background:#fafafa;padding:6px;border-radius:6px;margin-bottom:6px;}
.locked{opacity:.6;}
.hidden{display:none;}
</style>
</head>

<body>

<div class="card">
  <h2>GymTrack Stats</h2>
  <div class="row" style="align-items:center;margin-bottom:8px;">
    <button onclick="changeWeek(-1)">◀</button>
    <strong id="weekTitle">Week 1</strong>
    <button onclick="changeWeek(1)">▶</button>

    <button onclick="exportData()">Export Backup</button>
    <button onclick="document.getElementById('importFile').click()">Import Backup</button>
    <input type="file" id="importFile" accept=".json" hidden>

    <select id="weekType">
      <option>GVT</option>
      <option>Core Session</option>
      <option>Breakdown Banded</option>
      <option>Breakdown Pause</option>
      <option>Breakdown Other</option>
      <option>Mini-Peak</option>
      <option>Peak</option>
    </select>

    <button onclick="cycleComplete()">Cycle Complete</button>
    <button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
  </div>

  <div id="weekGrid" class="week-grid"></div>
</div>

<div id="sessions"></div>

<div class="card">
  <canvas id="rmChart"></canvas>
</div>

<script>
/* ================== DB ================== */
const MAX_WEEKS = 12;
let currentWeek = 1;
const typeSel = document.getElementById('weekType');

function freshDB(){
  return {
    cycle: 1,
    weeks: Object.fromEntries(
      Array.from({length:MAX_WEEKS},(_,i)=>[i+1,{sessions:[]}])
    ),
    pbs:{Squat:0,Bench:0,Deadlift:0}
  };
}

let db = JSON.parse(localStorage.getItem('db')) || freshDB();
function saveDB(){ localStorage.setItem('db', JSON.stringify(db)); }

/* ================== HELPERS ================== */
function prevSession(lift){
  for(let w=MAX_WEEKS; w>=1; w--){
    const s = db.weeks[w].sessions
      .filter(x=>x.completed && x.lift===lift)
      .pop();
    if(s) return s;
  }
  return null;
}

/* ================== SESSIONS ================== */
function addSession(lift){
  const prev = prevSession(lift);
  db.weeks[currentWeek].sessions.push({
    id: crypto.randomUUID(),
    lift,
    weekType: typeSel.value,
    sets: Array.from({length:typeSel.value==='GVT'?10:5},()=>({w:'',r:''})),
    isolations: prev ? prev.isolations.map(i=>({...i})) : Array.from({length:3},()=>({})),
    notes: prev?.notes || '',
    completed:false
  });
  saveDB();
  render();
}

function deleteSession(id){
  db.weeks[currentWeek].sessions =
    db.weeks[currentWeek].sessions.filter(s=>s.id!==id);
  saveDB(); render();
}

function completeSession(id){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.completed=true;

  const maxW=Math.max(...s.sets.map(x=>Number(x.w)||0));
  if(['Squat','Bench','Deadlift'].includes(s.lift) && maxW>db.pbs[s.lift]){
    db.pbs[s.lift]=maxW;
  }

  saveDB(); render();
}

function editSession(id){
  const s=db.weeks[currentWeek].sessions.find(x=>x.id===id);
  s.completed=false;
  saveDB(); render();
}

/* ================== RENDER ================== */
function render(){
  document.getElementById('weekTitle').textContent=`Week ${currentWeek}`;
  renderWeekButtons();

  const c=document.getElementById('sessions');
  c.innerHTML='';

  db.weeks[currentWeek].sessions.forEach(s=>{
    const prev=prevSession(s.lift);
    const card=document.createElement('div');
    card.className='card session'+(s.completed?' locked':'');

    let prevHTML='<strong>Previous</strong><br>';
    if(prev){
      prevHTML+=prev.sets.map(x=>`${x.w}×${x.r}`).join('<br>')+'<br>';
      prevHTML+=prev.isolations.map(i=>i.name?`${i.name} ${i.sets}×${i.reps}@${i.weight}`:'').join('<br>');
      if(prev.notes) prevHTML+=`<br><em>${prev.notes}</em>`;
    }

    card.innerHTML=`
      <h3>${s.lift}</h3>
      <div class="row">
        <div class="prev">${prevHTML}</div>
        <div class="curr">
          ${s.sets.map((x,i)=>`
            <div class="set">
              ${i+1}
              <input type="number" value="${x.w}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.sets[${i}].w=this.value;saveDB()">
              <input type="number" value="${x.r}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.sets[${i}].r=this.value;saveDB()">
            </div>`).join('')}
          <strong>Isolation</strong>
          ${s.isolations.map((i,idx)=>`
            <div class="iso">
              <input value="${i.name||''}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.isolations[${idx}].name=this.value;saveDB()">
              <input type="number" value="${i.sets||''}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.isolations[${idx}].sets=this.value;saveDB()">
              <input type="number" value="${i.reps||''}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.isolations[${idx}].reps=this.value;saveDB()">
              <input type="number" value="${i.weight||''}" ${s.completed?'disabled':''}
                onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.isolations[${idx}].weight=this.value;saveDB()">
            </div>`).join('')}
          <textarea ${s.completed?'disabled':''}
            onblur="s=db.weeks[currentWeek].sessions.find(z=>z.id==='${s.id}');s.notes=this.value;saveDB()">${s.notes}</textarea>

          ${s.completed
            ? `<button onclick="editSession('${s.id}')">Edit</button>`
            : `<button onclick="completeSession('${s.id}')">Complete</button>`
          }
          <button onclick="deleteSession('${s.id}')">Delete</button>
        </div>
      </div>`;
    c.append(card);
  });

  drawChart();
}

/* ================== NAV ================== */
function changeWeek(d){
  currentWeek=Math.max(1,Math.min(MAX_WEEKS,currentWeek+d));
  render();
}
function renderWeekButtons(){
  const g=document.getElementById('weekGrid'); g.innerHTML='';
  for(let i=1;i<=MAX_WEEKS;i++){
    const b=document.createElement('button');
    b.textContent=`W${i}`;
    b.className='week-btn '+(i===currentWeek?'active':'inactive');
    b.onclick=()=>{currentWeek=i;render();};
    g.append(b);
  }
}

/* ================== CYCLE / RESET ================== */
function cycleComplete(){
  if(!confirm(`Complete Cycle ${db.cycle} and export backup?`)) return;
  exportData();
  db.cycle++;
  db.weeks=freshDB().weeks;
  currentWeek=1;
  saveDB();
  render();
}

function resetAll(){
  if(!confirm('Delete all data?')) return;
  db=freshDB();
  saveDB();
  render();
}

/* ================== IMPORT / EXPORT ================== */
function exportData(){
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='gymtrack-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('importFile').onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    db=JSON.parse(ev.target.result);
    saveDB(); render();
  };
  r.readAsText(e.target.files[0]);
};

/* ================== CHART ================== */
let chart;
function drawChart(){
  const ctx=document.getElementById('rmChart');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:Array.from({length:MAX_WEEKS},(_,i)=>`W${i+1}`),
      datasets:['Squat','Bench','Deadlift'].map(l=>({
        label:l,
        data:Array.from({length:MAX_WEEKS},(_,i)=>{
          const s=db.weeks[i+1].sessions
            .filter(x=>x.completed && x.lift===l)
            .pop();
          return s?Math.max(...s.sets.map(x=>Number(x.w)||0)):null;
        }),
        fill:false
      }))
    }
  });
}

/* ================== INIT ================== */
render();
</script>
</body>
</html>

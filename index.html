<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;background:#f5f5f5;padding:10px;margin:0;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.week-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:4px;margin-top:8px;}
.week-btn{padding:6px;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;}
.week-btn.active{background:#3b82f6;color:#fff;}
.week-btn.inactive{background:#e5e7eb;}
select,input,textarea,button{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:0.85rem;}
input[type=number]{width:70px;}
textarea{resize:none;width:100%;}
button{cursor:pointer;}
.session{border-top:1px solid #eee;padding-top:8px;margin-top:8px;}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:8px;border-radius:6px;flex:1;min-width:90px;}
.curr{flex:1;min-width:90px;}
.set{display:flex;gap:4px;margin-bottom:4px;align-items:center;flex-wrap:wrap;}
.iso{background:#fafafa;padding:6px;border-radius:6px;margin-bottom:6px;}
.small{font-size:11px;color:#555;}
.locked{opacity:.6;}
.hidden{display:none;}
.stats-week{border-bottom:1px solid #ddd;padding:8px 0;}
.stats-lift{margin-left:10px;}
</style>
</head>
<body>

<div class="card">
  <h2>GymTrack Stats</h2>
  <div class="row" style="align-items:center;gap:6px;margin-bottom:8px;">
    <button onclick="changeWeek(-1)">◀</button>
    <strong id="weekTitle">Week 1</strong>
    <button onclick="changeWeek(1)">▶</button>

    <select id="weekType">
      <option>GVT</option>
      <option>Core Session</option>
      <option>Breakdown Banded</option>
      <option>Breakdown Pause</option>
      <option>Breakdown Other</option>
      <option>Mini-Peak</option>
      <option>Peak</option>
    </select>

    <!-- Backup/Import/Export -->
    <button onclick="exportBackup()">Export</button>
    <label>
      <input type="file" hidden onchange="importBackup(event)">
      <button type="button">Import</button>
    </label>

    <!-- New Cycle / Factory Reset -->
    <button onclick="startNewCycle()">New Cycle</button>
    <button onclick="factoryReset()" style="background:#ef4444;color:#fff">Factory Reset</button>

    <button onclick="toggleStats()">Cycle Stats</button>
  </div>

  <div id="weekGrid" class="week-grid"></div>
</div>

<div id="loggerView">
  <div id="sessions"></div>
  <div class="card">
    <canvas id="rmChart"></canvas>
  </div>
</div>

<div id="statsView" class="hidden">
  <div class="card">
    <h3>Cycle Stats (Weeks 1–12)</h3>
    <div id="statsContent"></div>
  </div>
</div>

<script>
const MAX_WEEKS = 12;
let currentWeek = 1;
let cycle = Number(localStorage.getItem('cycle')) || 1;
const typeSel = document.getElementById('weekType');

let db = JSON.parse(localStorage.getItem('db')) || {
  lifts:{Squat:[],Bench:[],Deadlift:[]},
  isolations:{Squat:[],Bench:[],Deadlift:[]},
  pbs:{Squat:0,Bench:0,Deadlift:0}
};

function saveDB(){ localStorage.setItem('db', JSON.stringify(db)); localStorage.setItem('cycle', cycle); }

/* ---------------- BACKUP ---------------- */
function exportBackup(){
  const payload={cycle,date:new Date().toISOString(),data:db};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gymtrack-backup.json'; a.click();
}
function importBackup(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=()=>{
    const parsed=JSON.parse(r.result);
    if(parsed.data){ db=parsed.data; cycle=parsed.cycle||1; saveDB(); render(); alert('Backup imported'); }
  }; r.readAsText(file);
}

/* ---------------- CYCLE ---------------- */
function startNewCycle(){ 
  if(confirm(`Start new cycle? (Cycle ${cycle} will be archived)`)){ cycle++; currentWeek=1; saveDB(); render(); } 
}
function factoryReset(){ 
  if(!confirm('FACTORY RESET\n\nThis deletes ALL data.')) return; 
  if(!confirm('Are you absolutely sure?')) return; 
  localStorage.clear(); location.reload(); 
}

/* ---------------- HELPERS ---------------- */
function prevSession(lift,type){ return db.lifts[lift].filter(x=>x.completed && x.weekType===type).pop() || null; }
function prevIsolation(lift, week){ return db.isolations[lift].find(s=>s.week===week-1) || null; }
function isWeekLocked(week){ return ['Squat','Bench','Deadlift'].some(lift=>db.lifts[lift].find(s=>s.week===week)?.completed); }

/* ---------------- SESSION CREATION (working version) ---------------- */
function createSession(lift, week, type){
  let ses=db.lifts[lift].find(s=>s.week===week);
  if(!ses){ ses={week,weekType:type,sets:[],isolations:[],notes:'',completed:false}; db.lifts[lift].push(ses);}
  else ses.weekType=type;

  const expectedSets = type==='GVT'?10:5;
  if(ses.sets.length !== expectedSets) ses.sets = Array.from({length:expectedSets}, (_,i)=> ses.sets[i] || {w:'', r:''});

  if(ses.isolations.length < 3){
    const prev = prevIsolation(lift, week);
    ses.isolations = prev ? prev.isolations.map(i=>({...i})) : Array.from({length:3}, ()=>({}));
  }
  return ses;
}

/* ---------------- SESSION ACTIONS ---------------- */
function completeSession(lift, week){
  const s=db.lifts[lift].find(sess=>sess.week===week);
  s.completed=true;
  db.isolations[lift].push({week, isolations:s.isolations.map(i=>({...i}))});
  const maxW=Math.max(...s.sets.map(x=>Number(x.w)||0));
  if(maxW>db.pbs[lift]) db.pbs[lift]=maxW;
  saveDB(); checkCycleComplete(); render();
}
function editSession(lift, week){ db.lifts[lift].find(sess=>sess.week===week).completed=false; saveDB(); render(); }

/* ---------------- CYCLE COMPLETE ---------------- */
function checkCycleComplete(){
  if(currentWeek!==12) return;
  const done=['Squat','Bench','Deadlift'].every(l=>{ const s=db.lifts[l].find(x=>x.week===12); return s && s.completed; });
  if(done) setTimeout(()=>{if(confirm(`Cycle ${cycle} complete. Send to backup?`)){ exportBackup(); cycle++; currentWeek=1; saveDB(); render(); }},300);
}

/* ---------------- RENDER ---------------- */
function render(){
  document.getElementById('weekTitle').textContent=`Week ${currentWeek} (Cycle ${cycle})`;
  renderWeekButtons();
  typeSel.disabled = isWeekLocked(currentWeek);

  const container=document.getElementById('sessions'); container.innerHTML='';

  ['Squat','Bench','Deadlift'].forEach(lift=>{
    const s=createSession(lift,currentWeek,typeSel.value);
    const sessionObj=db.lifts[lift].find(sess=>sess.week===currentWeek);

    const card=document.createElement('div'); card.className='card session'+(s.completed?' locked':'');
    card.innerHTML=`<h3>${lift}</h3>`;
    const row=document.createElement('div'); row.className='row';

    const prev=document.createElement('div'); prev.className='prev'; prev.innerHTML='<strong>Previous</strong><br>';
    const pMain=prevSession(lift,s.weekType); if(pMain) pMain.sets.forEach(x=>prev.innerHTML+=`${x.w}×${x.r}<br>`);
    const pIso=prevIsolation(lift,currentWeek); if(pIso) pIso.isolations.forEach(i=>{if(i.name) prev.innerHTML+=`${i.name} ${i.sets||''}×${i.reps||''}@${i.weight||''}<br>`;});

    const curr=document.createElement('div'); curr.className='curr';

    // MAIN SETS
    sessionObj.sets.forEach((set,i)=>{
      const div=document.createElement('div'); div.className='set'; div.textContent=i+1;
      const w=document.createElement('input'); w.type='number'; w.placeholder='Weight'; w.value=set.w;
      w.addEventListener('blur',()=>{ set.w=w.value; saveDB(); });
      const r=document.createElement('input'); r.type='number'; r.placeholder='Reps'; r.value=set.r;
      r.addEventListener('blur',()=>{ set.r=r.value; saveDB(); });
      div.append(w,r); curr.appendChild(div);
    });

    // ISOLATIONS
    curr.innerHTML+='<strong>Isolation</strong>';
    sessionObj.isolations.forEach((iso,idx)=>{
      const div=document.createElement('div'); div.className='iso';
      const name=document.createElement('input'); name.placeholder='Exercise'; name.value=iso.name||'';
      name.addEventListener('blur',()=>{ iso.name=name.value; saveDB(); });
      const sets=document.createElement('input'); sets.type='number'; sets.placeholder='Sets'; sets.value=iso.sets||'';
      sets.addEventListener('blur',()=>{ iso.sets=sets.value; saveDB(); });
      const reps=document.createElement('input'); reps.type='number'; reps.placeholder='Reps'; reps.value=iso.reps||'';
      reps.addEventListener('blur',()=>{ iso.reps=reps.value; saveDB(); });
      const weight=document.createElement('input'); weight.type='number'; weight.placeholder='Weight'; weight.value=iso.weight||'';
      weight.addEventListener('blur',()=>{ iso.weight=weight.value; saveDB(); });
      div.append(name,sets,reps,weight); curr.appendChild(div);
    });

    // NOTES
    const note=document.createElement('textarea'); note.placeholder='Notes'; note.value=sessionObj.notes;
    note.addEventListener('blur',()=>{ sessionObj.notes=note.value; saveDB(); });
    curr.appendChild(note);

    // BUTTON
    const btn=document.createElement('button');
    if(s.completed){ btn.textContent='Edit Session'; btn.onclick=()=>editSession(lift,currentWeek); }
    else{ btn.textContent='Complete Session'; btn.onclick=()=>completeSession(lift,currentWeek); }
    curr.appendChild(btn);

    row.append(prev,curr); card.append(row); container.appendChild(card);
  });

  drawChart();
}

/* ---------------- NAV ---------------- */
function changeWeek(d){ currentWeek=Math.max(1,Math.min(MAX_WEEKS,currentWeek+d)); render(); }
function renderWeekButtons(){ const g=document.getElementById('weekGrid'); g.innerHTML=''; for(let i=1;i<=MAX_WEEKS;i++){ const b=document.createElement('button'); b.textContent=`W${i}`; b.className='week-btn '+(i===currentWeek?'active':'inactive'); b.onclick=()=>{currentWeek=i;render();}; g.appendChild(b); } }

/* ---------------- STATS ---------------- */
function toggleStats(){ document.getElementById('loggerView').classList.toggle('hidden'); document.getElementById('statsView').classList.toggle('hidden'); if(!document.getElementById('statsView').classList.contains('hidden')) renderStats(); }
function renderStats(){
  const c=document.getElementById('statsContent'); c.innerHTML='';
  for(let w=1;w<=MAX_WEEKS;w++){
    const d=document.createElement('div'); d.className='stats-week'; d.innerHTML=`<strong>Week ${w}</strong>`;
    ['Squat','Bench','Deadlift'].forEach(l=>{
      const s=db.lifts[l].find(x=>x.week===w);
      if(s) d.innerHTML+=`<div class="stats-lift"><strong>${l}</strong> (${s.weekType})<br>${s.sets.map(x=>`${x.w}×${x.r}`).join(', ')}<br>${s.isolations.map(i=>i.name?`${i.name} ${i.sets}×${i.reps}@${i.weight}`:'').join('<br>')}</div>`;
    });
    c.appendChild(d);
  }
}

/* ---------------- CHART ---------------- */
let chart;
function drawChart(){ if(chart) chart.destroy(); chart=new Chart(document.getElementById('rmChart'),{ type:'line', data:{ labels:Array.from({length:MAX_WEEKS},(_,i)=>`W${i+1}`), datasets:['Squat','Bench','Deadlift'].map(l=>({ label:l, data:Array.from({length:MAX_WEEKS},(_,i)=>{ const s=db.lifts[l].find(x=>x.week===i+1); return s?Math.max(...s.sets.map(x=>Number(x.w)||0)):null; }) })) }, options:{responsive:true} }); }

/* ---------------- INIT ---------------- */
render();

/* ---------------- SERVICE WORKER ---------------- */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>

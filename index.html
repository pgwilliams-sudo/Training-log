<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Training Log PWA</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 16px;
}
h1, h2, h3 { margin: 6px 0; }
.card {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,.1);
}
select, input, button, textarea {
  padding: 6px;
  margin: 4px;
}
button {
  cursor: pointer;
}
.locked {
  opacity: 0.6;
  pointer-events: none;
}
.set-row {
  display: flex;
  gap: 6px;
  align-items: center;
}
.prev-box {
  background: #eef6ff;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 13px;
}
.pb { background: gold; padding: 2px 6px; border-radius: 4px; }
.up { background: #dcfce7; }
.down { background: #fee2e2; }
.iso-box {
  background: #f9fafb;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 12px;
}
textarea { width: 100%; max-length: 260; }
.week-btn { margin: 2px; }
</style>
</head>

<body>

<h1>Training Log</h1>

<div class="card">
  <strong>Weeks</strong><br/>
  <div id="weekButtons"></div>
</div>

<div class="card">
  Cycle:
  <select id="cycleSelect">
    <option value="Hybrid">Hybrid</option>
    <option value="Strength">Strength</option>
  </select>

  Session Type:
  <select id="sessionTypeSelect">
    <option>GVT</option>
    <option>Core</option>
    <option>Breakdown Banded</option>
    <option>Breakdown Pause</option>
    <option>Breakdown Other</option>
    <option>Mini-Peak</option>
    <option>Peak</option>
  </select>
</div>

<div id="sessions"></div>

<button onclick="softReset()">Reset Current Cycle</button>

<script>
/* ---------------- STORAGE ---------------- */
const DB_KEY = "trainingDB_v2";
let db = JSON.parse(localStorage.getItem(DB_KEY)) || { sessions: [], isolations: {} };
let currentWeek = 1;

/* ---------------- HELPERS ---------------- */
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function setsFor(type){ return type==="GVT" ? 10 : 5; }
function liftList(){ return ["Squat","Bench","Deadlift"]; }

/* ---------------- WEEK BUTTONS ---------------- */
function renderWeeks(){
  let html="";
  for(let i=1;i<=12;i++){
    html+=`<button class="week-btn" onclick="goWeek(${i})">Week ${i}</button>`;
  }
  document.getElementById("weekButtons").innerHTML=html;
}
function goWeek(w){ currentWeek=w; render(); }

/* ---------------- SESSION LOOKUPS ---------------- */
function findPrevSession(lift,type){
  return [...db.sessions]
    .filter(s=>s.lift===lift && s.type===type)
    .sort((a,b)=>b.time-a.time)[0];
}

/* ---------------- RENDER ---------------- */
function render(){
  const cycle = cycleSelect.value;
  const type = sessionTypeSelect.value;
  let html="";

  liftList().forEach(lift=>{
    const prev = findPrevSession(lift,type);
    const locked = prev && prev.week===currentWeek;

    html+=`<div class="card ${locked?'locked':''}">
      <h3>${lift}</h3>`;

    if(prev){
      html+=`<div class="prev-box">
        Prev: ${prev.sets.map(s=>`${s.w}Ã—${s.r}`).join(", ")}
      </div>`;
    }

    for(let i=0;i<setsFor(type);i++){
      html+=`<div class="set-row">
        <input type="number" placeholder="Wt" 
          onblur="autoCopyWeight(event,'${lift}',${i})">
        <input type="number" placeholder="Reps"
          onblur="autoCopyReps(event,'${lift}',${i})">
      </div>`;
    }

    html+=`<h4>Isolations</h4>`;
    for(let i=0;i<3;i++){
      html+=`<div class="set-row">
        <input placeholder="Name">
        <input type="number" placeholder="Sets">
        <input type="number" placeholder="Reps">
        <input type="number" placeholder="Wt">
      </div>`;
    }

    html+=`<textarea placeholder="Notes (260 chars)"></textarea>
      <button onclick="completeSession('${lift}')">Complete Session</button>
    </div>`;
  });

  document.getElementById("sessions").innerHTML=html;
}

/* ---------------- COMPLETE ---------------- */
function completeSession(lift){
  const card=[...document.querySelectorAll(".card")]
    .find(c=>c.querySelector("h3")?.innerText===lift);

  const rows=[...card.querySelectorAll(".set-row")].slice(0,setsFor(sessionTypeSelect.value));
  const sets=rows.map(r=>({
    w:r.children[0].value,
    r:r.children[1].value
  }));

  db.sessions.push({
    week:currentWeek,
    lift,
    type:sessionTypeSelect.value,
    cycle:cycleSelect.value,
    sets,
    time:Date.now()
  });

  saveDB();
  render();
}

/* ---------------- AUTOCOPY ---------------- */
function autoCopyWeight(e,lift,idx){
  if(idx!==0) return;
  const val=e.target.value;
  if(!val) return;
  const rows=[...e.target.closest(".card").querySelectorAll(".set-row")];
  rows.slice(1).forEach(r=>r.children[0].value=val);
}
function autoCopyReps(e,lift,idx){
  if(idx!==0) return;
  if(sessionTypeSelect.value==="GVT") return;
  const val=e.target.value;
  if(!val) return;
  const rows=[...e.target.closest(".card").querySelectorAll(".set-row")];
  rows.slice(1).forEach(r=>r.children[1].value=val);
}

/* ---------------- RESET ---------------- */
function softReset(){
  if(confirm("Reset current cycle? History is kept.")){
    db.sessions=[];
    saveDB();
    render();
  }
}

/* ---------------- INIT ---------------- */
renderWeeks();
render();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack Stats</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#3b82f6">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;background:#f5f5f5;padding:10px;margin:0;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.week-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:4px;margin-top:8px;}
.week-btn{padding:6px;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;}
.week-btn.active{background:#3b82f6;color:#fff;}
.week-btn.inactive{background:#e5e7eb;}
select,input,textarea,button{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:0.85rem;}
input[type=number]{width:70px;}
textarea{resize:none;width:100%;}
.session{border-top:1px solid #eee;padding-top:8px;margin-top:8px;}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:8px;border-radius:6px;flex:1;}
.curr{flex:1;}
.set{display:flex;gap:4px;margin-bottom:4px;}
.iso{background:#fafafa;padding:6px;border-radius:6px;margin-bottom:6px;}
.locked{opacity:.6;}
.hidden{display:none;}
</style>
</head>

<body>

<div class="card">
  <h2>GymTrack Stats</h2>
  <div class="row">
    <button onclick="changeWeek(-1)">◀</button>
    <strong id="weekTitle">Week 1</strong>
    <button onclick="changeWeek(1)">▶</button>

    <select id="weekType">
      <option>GVT</option>
      <option>Core Session</option>
      <option>Breakdown Banded</option>
      <option>Breakdown Pause</option>
      <option>Breakdown Other</option>
      <option>Mini-Peak</option>
      <option>Peak</option>
    </select>

    <button onclick="toggleStats()">Cycle Stats</button>
    <button onclick="exportData()">Export</button>
    <button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
  </div>

  <div id="weekGrid" class="week-grid"></div>
</div>

<div id="loggerView">
  <div id="sessions"></div>
  <div class="card"><canvas id="rmChart"></canvas></div>
</div>

<div id="statsView" class="hidden">
  <div class="card">
    <h3>Cycle Stats</h3>
    <div id="statsContent"></div>
  </div>
</div>

<script>
const MAX_WEEKS = 12;
let currentWeek = 1;
const LIFTS = ['Squat','Bench','Deadlift','Row','Overhead Press'];

let db = JSON.parse(localStorage.getItem('db')) || {
  cycle:1,
  weeks:{},
  pbs:{Squat:0,Bench:0,Deadlift:0}
};

function saveDB(){ localStorage.setItem('db', JSON.stringify(db)); }

function ensureWeek(w){
  if(!db.weeks[w]) db.weeks[w]={ type:'Core Session', sessions:[] };
}

function getMostRecentSession(lift){
  let all=[];
  Object.values(db.weeks).forEach(w=>{
    w.sessions.forEach(s=>{
      if(s.lift===lift && s.completed) all.push(s);
    });
  });
  return all.length ? all[all.length-1] : null;
}

function render(){
  ensureWeek(currentWeek);
  document.getElementById('weekTitle').textContent=`Week ${currentWeek}`;
  renderWeekButtons();

  const week=db.weeks[currentWeek];
  const container=document.getElementById('sessions');
  container.innerHTML='';

  if(week.sessions.length===0){
    container.innerHTML='<div class="card"><em>No sessions added for this week</em></div>';
  }

  week.sessions.forEach((ses)=>{
    const prev=getMostRecentSession(ses.lift);
    const card=document.createElement('div');
    card.className='card session'+(ses.completed?' locked':'');
    card.innerHTML=`<h3>${ses.lift}</h3>`;
    const row=document.createElement('div'); row.className='row';

    const prevBox=document.createElement('div'); prevBox.className='prev';
    if(prev){
      prevBox.innerHTML='<strong>Previous</strong><br>';
      prev.sets.forEach(s=>prevBox.innerHTML+=`${s.w}×${s.r}<br>`);
    }

    const curr=document.createElement('div'); curr.className='curr';
    ses.sets.forEach((s,i)=>{
      curr.innerHTML+=`
      <div class="set">
        ${i+1}
        <input type="number" value="${s.w}" onblur="s.w=this.value;saveDB()">
        <input type="number" value="${s.r}" onblur="s.r=this.value;saveDB()">
      </div>`;
    });

    row.append(prevBox,curr);
    card.append(row);
    container.append(card);
  });

  drawChart();
}

function drawChart(){
  const ctx=document.getElementById('rmChart');
  if(window.chart) chart.destroy();

  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:Array.from({length:MAX_WEEKS},(_,i)=>`W${i+1}`),
      datasets:['Squat','Bench','Deadlift'].map(l=>({
        label:l,
        data:Array.from({length:MAX_WEEKS},(_,i)=>{
          const w=db.weeks[i+1];
          if(!w) return null;
          const s=w.sessions.filter(x=>x.lift===l);
          if(!s.length) return null;
          return Math.max(...s.flatMap(x=>x.sets.map(z=>Number(z.w)||0)));
        }),
        fill:false
      }))
    }
  });
}

function changeWeek(d){
  currentWeek=Math.max(1,Math.min(MAX_WEEKS,currentWeek+d));
  render();
}

function renderWeekButtons(){
  const g=document.getElementById('weekGrid'); g.innerHTML='';
  for(let i=1;i<=MAX_WEEKS;i++){
    const b=document.createElement('button');
    b.textContent=`W${i}`;
    b.className='week-btn '+(i===currentWeek?'active':'inactive');
    b.onclick=()=>{currentWeek=i;render();};
    g.append(b);
  }
}

function toggleStats(){
  document.getElementById('loggerView').classList.toggle('hidden');
  document.getElementById('statsView').classList.toggle('hidden');
}

function exportData(){
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='gymtrack-backup.json';
  a.click();
}

function resetAll(){
  if(confirm('Delete all data?')){
    localStorage.clear(); location.reload();
  }
}

render();
</script>
</body>
</html>

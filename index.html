<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Training Logger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial;background:#f3f4f6;padding:12px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,.08)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.session{margin-top:10px}
.set{display:flex;gap:6px;margin-bottom:6px}
.iso{background:#f9fafb;padding:8px;border-radius:6px;margin-bottom:6px}
.small{font-size:12px;color:#555}
.locked{opacity:.6;pointer-events:none}
textarea{width:100%;resize:none}

.weight-up{background:#dcfce7}
.weight-down{background:#fee2e2}
.weight-pb{background:#fde68a}
.pb-badge{background:#fde68a;padding:2px 6px;border-radius:4px;margin-left:6px;font-size:12px}
</style>
</head>

<body>

<div class="card">
  <strong id="weekLabel">Week 1</strong>
  <div class="row">
    <button onclick="changeWeek(-1)">◀</button>
    <button onclick="changeWeek(1)">▶</button>

    <select id="cycle">
      <option>Strength</option>
      <option>Hybrid</option>
    </select>

    <select id="weekType">
      <option>GVT</option>
      <option>Core Session</option>
      <option>Breakdown Banded</option>
      <option>Breakdown Pause</option>
      <option>Breakdown Other</option>
      <option>Mini-Peak</option>
      <option>Peak</option>
    </select>

    <button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
  </div>
</div>

<div id="sessions"></div>

<div class="card">
  <strong>Theoretical 1RM Progress</strong>
  <div class="small" id="maxBox"></div>
  <canvas id="chart"></canvas>
</div>

<script>
/* ---------------- DATABASE ---------------- */
let db = JSON.parse(localStorage.getItem('db')) || {
  sessions: [],
  history: [],
  isolations: {},
  pbs: {}
};

const lifts = ['Squat','Bench','Deadlift'];
let currentWeek = 1;

/* ---------------- UTIL ---------------- */
const save = () => localStorage.setItem('db', JSON.stringify(db));
const getSession = (lift) =>
  db.sessions.find(s => s.week === currentWeek && s.lift === lift);

const heaviest1RM = sets =>
  Math.max(...sets.map(s => s.w && s.r ? Math.round(s.w*(1+s.r/30)) : 0),0);

const prevEquivalent = (lift, type, cycle) =>
  [...db.history].reverse().find(h =>
    h.lift===lift && h.weekType===type && h.cycle===cycle);

/* ---------------- RENDER ---------------- */
function render(){
  document.getElementById('weekLabel').textContent = `Week ${currentWeek}`;
  const container=document.getElementById('sessions');
  container.innerHTML='';

  lifts.forEach(lift=>{
    let s = getSession(lift);
    if(!s){
      s={week:currentWeek,lift,cycle:cycle.value,weekType:weekType.value,
         sets:[],isolations:[],notes:'',completed:false};
      db.sessions.push(s);
    }

    const gvt = s.weekType==='GVT';
    const setCount = gvt?10:5;
    const fixedReps = gvt?(s.cycle==='Strength'?5:10):null;

    while(s.sets.length<setCount)
      s.sets.push({w:'',r:fixedReps||''});
    s.sets = s.sets.slice(0,setCount);

    while(s.isolations.length<3)
      s.isolations.push({});

    const prev = prevEquivalent(lift,s.weekType,s.cycle);

    const card=document.createElement('div');
    card.className='card session'+(s.completed?' locked':'');
    card.innerHTML=`<strong>${lift}${s.completed?'<span class="pb-badge">Completed</span>':''}</strong>`;

    /* SETS */
    s.sets.forEach((set,i)=>{
      card.innerHTML+=`
      <div class="set">
        ${i+1}
        <input type="number" value="${set.w}" 
          class="${weightClass(lift,set.w,prev?.sets?.[i]?.w)}"
          oninput="setMain('${lift}',${i},'w',this.value)">
        <input type="number" value="${set.r}" ${fixedReps?'disabled':''}
          oninput="setMain('${lift}',${i},'r',this.value)">
      </div>`;
    });

    /* ISOLATIONS */
    card.innerHTML+='<div class="small">Isolation</div>';
    s.isolations.forEach((iso,i)=>{
      card.innerHTML+=`
      <div class="iso">
        <input placeholder="Exercise" value="${iso.name||''}"
          oninput="setIso('${lift}',${i},'name',this.value)">
        <div class="row">
          <input placeholder="Sets" value="${iso.sets||''}"
            oninput="setIso('${lift}',${i},'sets',this.value)">
          <input placeholder="Reps" value="${iso.reps||''}"
            oninput="setIso('${lift}',${i},'reps',this.value)">
          <input placeholder="Weight" value="${iso.weight||''}"
            class="${weightClass(lift,iso.weight,prev?.isolations?.[i]?.weight)}"
            oninput="setIso('${lift}',${i},'weight',this.value)">
        </div>
      </div>`;
    });

    card.innerHTML+=`
      <textarea maxlength="260" oninput="s.notes=this.value">${s.notes}</textarea>
      <button onclick="complete('${lift}')">Complete Session</button>
      ${s.completed?`<button onclick="unlock('${lift}')">Unlock</button>`:''}
    `;

    container.append(card);
  });

  drawChart();
  save();
}

/* ---------------- LOGIC ---------------- */
function weightClass(lift,c,p){
  if(!c) return '';
  c=Number(c); p=Number(p);
  if(!db.pbs[lift] || c>=db.pbs[lift]) return 'weight-pb';
  if(c>p) return 'weight-up';
  if(c<p) return 'weight-down';
  return '';
}

function setMain(lift,i,f,v){
  const s=getSession(lift);
  s.sets[i][f]=v;

  /* AUTO COPY */
  if(f==='w' && s.weekType==='GVT' && i===0){
    for(let j=1;j<s.sets.length;j++)
      if(!s.sets[j].w) s.sets[j].w=v;
  }
  if(f==='r' && s.weekType!=='GVT' && i===0){
    for(let j=1;j<s.sets.length;j++)
      if(!s.sets[j].r) s.sets[j].r=v;
  }

  save(); render();
}

function setIso(l,i,f,v){
  getSession(l).isolations[i][f]=v;
  save();
}

function complete(lift){
  const s=getSession(lift);
  s.completed=true;

  const oneRM = s.weekType==='Peak'
    ? Math.max(...s.sets.map(x=>Number(x.w)||0))
    : heaviest1RM(s.sets);

  db.history.push({...s, oneRM});
  db.pbs[lift]=Math.max(db.pbs[lift]||0,oneRM);
  save(); render();
}

function unlock(lift){
  getSession(lift).completed=false;
  render();
}

function changeWeek(d){
  currentWeek=Math.max(1,currentWeek+d);
  render();
}

function resetAll(){
  if(confirm('Delete all data?')){
    localStorage.clear();
    location.reload();
  }
}

/* ---------------- CHART ---------------- */
let chart;
function drawChart(){
  const ctx=document.getElementById('chart');
  if(chart) chart.destroy();

  const data=lifts.map(l=>{
    return db.history.filter(h=>h.lift===l).map(h=>h.oneRM);
  });

  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:data[0].map((_,i)=>i+1),
      datasets:lifts.map((l,i)=>({
        label:l,data:data[i],borderWidth:2
      }))
    }
  });

  document.getElementById('maxBox').textContent =
    'Highest 1RM achieved: '+
    Math.max(...db.history.map(h=>h.oneRM||0),0);
}

/* ---------------- DROPDOWNS ---------------- */
cycle.onchange = weekType.onchange = ()=>{
  lifts.forEach(l=>{
    const s=getSession(l);
    if(!s.completed){
      s.cycle=cycle.value;
      s.weekType=weekType.value;
      s.sets=[];
    }
  });
  render();
};

render();
</script>
</body>
</html>

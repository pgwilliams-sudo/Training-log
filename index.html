<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;background:#f5f5f5;margin:0;padding:10px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.row{display:flex;gap:8px;flex-wrap:wrap}
button,select,input,textarea{padding:6px;border-radius:6px;border:1px solid #ccc;font-size:.85rem}
button{cursor:pointer}
.week-btn{padding:6px;border:none;border-radius:6px}
.week-btn.active{background:#3b82f6;color:#fff}
.week-btn.inactive{background:#e5e7eb}
.prev{background:#f9fafb;border:1px dashed #bbb;padding:8px;border-radius:6px;flex:1;min-width:120px}
.curr{flex:2;min-width:180px}
.set{display:flex;gap:4px;margin-bottom:4px}
.iso{background:#fafafa;padding:6px;border-radius:6px;margin-bottom:6px}
.locked{opacity:.6}
.hidden{display:none}
</style>

</head>

<body>

<!-- HEADER -->

<div class="card">
  <h2>GymTrack</h2>

  <div class="row">
    <button onclick="changeWeek(-1)">◀</button>
    <strong id="weekTitle">Week 1</strong>
    <button onclick="changeWeek(1)">▶</button>

```
<button onclick="addSession()">Add Session</button>
<button onclick="cycleComplete()">Cycle Complete</button>

<button onclick="exportData()">Export</button>
<button onclick="document.getElementById('importFile').click()">Import</button>
<input id="importFile" type="file" accept=".json" hidden>

<button onclick="resetAll()" style="background:#ef4444;color:#fff">Reset</button>
```

  </div>

  <div id="weekGrid" class="row" style="margin-top:8px"></div>
</div>

<!-- MAIN -->

<div id="sessions"></div>

<script>
/* ================= DATA ================= */

const MAX_WEEKS = 12;
let currentWeek = 1;

const LIFTS = ["Squat","Bench","Deadlift","Row","Overhead Press"];

let db = JSON.parse(localStorage.getItem("db")) || {
  cycle: 1,
  weeks: {}
};

function saveDB(){
  localStorage.setItem("db", JSON.stringify(db));
}

/* ================= HELPERS ================= */

function getWeek(){
  if(!db.weeks[currentWeek]) db.weeks[currentWeek] = [];
  return db.weeks[currentWeek];
}

function mostRecentIsolation(lift){
  for(let w=currentWeek-1; w>=1; w--){
    const week = db.weeks[w];
    if(!week) continue;
    for(const s of week){
      if(s.lift===lift && s.completed && s.isolations){
        return s.isolations.map(i=>({...i}));
      }
    }
  }
  return [{},{},{}];
}

function getPreviousMainSession(currentSession) {
  const weekSessions = db.weeks[currentWeek] || [];
  const currentIndex = weekSessions.findIndex(s => s.id === currentSession.id);

  // 1️⃣ Same week, earlier sessions
  for (let i = currentIndex - 1; i >= 0; i--) {
    const s = weekSessions[i];
    if (s.completed && s.lift === currentSession.lift) {
      return s;
    }
  }

  // 2️⃣ Previous weeks
  for (let w = currentWeek - 1; w >= 1; w--) {
    const sessions = db.weeks[w];
    if (!sessions) continue;

    for (let i = sessions.length - 1; i >= 0; i--) {
      const s = sessions[i];
      if (s.completed && s.lift === currentSession.lift) {
        return s;
      }
    }
  }

  return null;
}

function getPreviousIsolationSession(currentSession) {
  const weekSessions = db.weeks[currentWeek] || [];
  const currentIndex = weekSessions.findIndex(s => s.id === currentSession.id);

  // 1️⃣ Same week, earlier sessions
  for (let i = currentIndex - 1; i >= 0; i--) {
    const s = weekSessions[i];
    if (
      s.completed &&
      s.lift === currentSession.lift &&
      s.isolations &&
      s.isolations.some(i => i.name)
    ) {
      return s;
    }
  }

  // 2️⃣ Previous weeks
  for (let w = currentWeek - 1; w >= 1; w--) {
    const sessions = db.weeks[w];
    if (!sessions) continue;

    for (let i = sessions.length - 1; i >= 0; i--) {
      const s = sessions[i];
      if (
        s.completed &&
        s.lift === currentSession.lift &&
        s.isolations &&
        s.isolations.some(i => i.name)
      ) {
        return s;
      }
    }
  }

  return null;
}

/* ================= SESSION OPS ================= */

function addSession(){
  getWeek().push({
    id: crypto.randomUUID(),
    lift: "Squat",
    sets: Array.from({length:5},()=>({w:"",r:""})),
    isolations: [{},{},{}],
    notes:"",
    completed:false
  });
  saveDB();
  render();
}

function deleteSession(id){
  db.weeks[currentWeek] = getWeek().filter(s=>s.id!==id);
  saveDB();
  render();
}

function completeSession(id){
  const s = getWeek().find(x=>x.id===id);
  s.completed = true;
  saveDB();
  render();
}

function editSession(id){
  const s = getWeek().find(x=>x.id===id);
  s.completed = false;
  saveDB();
  render();
}

/* ================= RENDER ================= */

function render(){
  document.getElementById("weekTitle").textContent = `Week ${currentWeek}`;
  renderWeekButtons();

  const c = document.getElementById("sessions");
  c.innerHTML = "";

  getWeek().forEach(session => {
    // Initialize isolations if needed
    if (
      !session.completed &&
      (!session.isolations || !session.isolations[0] || !session.isolations[0].name)
    ) {
      const prev = mostRecentIsolation(session.lift);
      session.isolations = prev ? prev.map(i => ({ ...i })) : [{}, {}, {}];
    }

    // Create session card
    const card = document.createElement("div");
    card.className = "card" + (session.completed?" locked":"");

    // Build previous session info
    const prev = document.createElement("div");
    prev.className = "prev";
    prev.innerHTML = "<strong>Previous</strong><br>";
    
    const prevMain = getPreviousMainSession(session);
    if (prevMain) {
      prev.innerHTML += '<em>Main:</em><br>';
      prevMain.sets.forEach(set => {
        if (set.w || set.r) {
          prev.innerHTML += `${set.w || ''} × ${set.r || ''}<br>`;
        }
      });

      if (prevMain.notes) {
        prev.innerHTML += '<em>Notes:</em><br>';
        prev.innerHTML += `${prevMain.notes}<br>`;
      }
    }
    
    const prevIsoSession = getPreviousIsolationSession(session);
    if (prevIsoSession) {
      prev.innerHTML += '<em>Isolation:</em><br>';
      prevIsoSession.isolations.forEach(i => {
        if (i.name) {
          prev.innerHTML += `${i.name} ${i.sets || ''}×${i.reps || ''}@${i.weight || ''}<br>`;
        }
      });
    }

    // Build current session form
    const curr = document.createElement("div");
    curr.className="curr";

    curr.innerHTML+=`
      <select ${session.completed?"disabled":""}
        onchange="updateLift('${session.id}',this.value)">
        ${LIFTS.map(l=>`<option ${l===session.lift?"selected":""}>${l}</option>`).join("")}
      </select>
    `;

    session.sets.forEach((set,i)=>{
      curr.innerHTML+=`
        <div class="set">
          ${i+1}
          <input type="number" value="${set.w}" ${session.completed?"disabled":""}
            onblur="updateSet('${session.id}',${i},'w',this.value)">
          <input type="number" value="${set.r}" ${session.completed?"disabled":""}
            onblur="updateSet('${session.id}',${i},'r',this.value)">
        </div>
      `;
    });

    session.isolations.forEach((iso,i)=>{
      curr.innerHTML+=`
        <div class="iso">
          <input placeholder="Exercise" value="${iso.name||""}" ${session.completed?"disabled":""}
            onblur="updateIso('${session.id}',${i},'name',this.value)">
          <input placeholder="Sets" value="${iso.sets||""}" ${session.completed?"disabled":""}
            onblur="updateIso('${session.id}',${i},'sets',this.value)">
          <input placeholder="Reps" value="${iso.reps||""}" ${session.completed?"disabled":""}
            onblur="updateIso('${session.id}',${i},'reps',this.value)">
          <input placeholder="Weight" value="${iso.weight||""}" ${session.completed?"disabled":""}
            onblur="updateIso('${session.id}',${i},'weight',this.value)">
        </div>
      `;
    });

    curr.innerHTML+=`
      <textarea ${session.completed?"disabled":""}
        onblur="updateNotes('${session.id}',this.value)">${session.notes}</textarea>

```
`;

curr.innerHTML+= session.completed
  ? `<button onclick="editSession('${session.id}')">Edit</button>`
  : `<button onclick="completeSession('${session.id}')">Complete</button>
     <button onclick="deleteSession('${session.id}')">Delete</button>`;

const row=document.createElement("div");
row.className="row";
row.append(prev,curr);
card.append(row);
c.append(card);
```

});
}

/* ================= UPDATES ================= */

function updateLift(id,v){getWeek().find(s=>s.id===id).lift=v;saveDB()}
function updateSet(id,i,f,v){getWeek().find(s=>s.id===id).sets[i][f]=v;saveDB()}
function updateIso(id,i,f,v){getWeek().find(s=>s.id===id).isolations[i][f]=v;saveDB()}
function updateNotes(id,v){getWeek().find(s=>s.id===id).notes=v;saveDB()}

/* ================= HEADER ================= */

function changeWeek(d){
currentWeek=Math.max(1,Math.min(MAX_WEEKS,currentWeek+d));
render();
}

function renderWeekButtons(){
const g=document.getElementById(“weekGrid”);
g.innerHTML=””;
for(let i=1;i<=MAX_WEEKS;i++){
const b=document.createElement(“button”);
b.textContent=`W${i}`;
b.className=“week-btn “+(i===currentWeek?“active”:“inactive”);
b.onclick=()=>{currentWeek=i;render()};
g.append(b);
}
}

function cycleComplete(){
if(confirm(`Cycle ${db.cycle} complete. Backup now?`)){
exportData();
}
db.cycle++;
saveDB();
alert(“Cycle advanced.”);
}

function resetAll(){
if(confirm(“Delete all data?”)){
localStorage.clear();
location.reload();
}
}

/* ================= IMPORT / EXPORT ================= */

function exportData(){
const blob=new Blob([JSON.stringify(db,null,2)],{type:“application/json”});
const a=document.createElement(“a”);
a.href=URL.createObjectURL(blob);
a.download=“gymtrack-backup.json”;
a.click();
}

document.getElementById(“importFile”).addEventListener(“change”,e=>{
const r=new FileReader();
r.onload=ev=>{
if(confirm(“Replace all data?”)){
db=JSON.parse(ev.target.result);
saveDB();
render();
}
};
r.readAsText(e.target.files[0]);
});

/* ================= INIT ================= */

render();
</script>

</body>
</html>
